{% extends "base.html" %}
{% block title %}Extraction Results - Bank Statement Extractor{% endblock %}
{% block content %}
<div class="container main-container my-5">
    <div class="header">
        <h1>Extraction Results</h1>
        <p class="lead">Your bank statement has been processed successfully</p>
    </div>
    <div class="download-box card card-body bg-light mb-4">
        <h3>Download Extracted Data</h3>
        <div class="row">
            {% for format, filename in result_files %}
            <div class="col-md-6 mb-3">
                <div class="d-grid">
                    <a href="{{ url_for('download_file', filename=filename) }}" class="btn btn-success btn-lg">
                        Download {{ format }} File
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% if account_info %}
    <div class="section card card-body mb-4">
        <h3>Account Information</h3>
        <div class="table-container">
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <th>Account Number</th>
                        <td>{{ account_info.get('account_number', 'N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Bank Name</th>
                        <td>{{ account_info.get('bank_name', 'N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Tax Id</th>
                        <td>{{ account_info.get('tax_id', 'N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Opening Balance</th>
                        <td>
                        {% set sorted_months = analysis_results.monthly_summary|dictsort(true) %}
                        {% if sorted_months %}
                            {% set first_month = sorted_months[0][1] %}
                            {{ first_month.opening_balance if first_month else account_info.get('opening_balance', 'N/A') }}
                        {% else %}
                            {{ account_info.get('opening_balance', 'N/A') }}
                        {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Closing Balance</th>
                        <td>{{ account_info.get('closing_balance', 'N/A') }}</td>
                    </tr>
                    <tr>
                        <th>Extraction Id</th>
                        <td>{{ account_info.get('extraction_id', 'N/A') }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% if transactions %}
    <div class="section card card-body mb-4">
        <h3>Transactions</h3>
        <div class="transaction-list table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        {% for col in transactions[0].keys() %}
                        <th>{{ col|replace('_', ' ')|title }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for txn in transactions %}
                    <tr>
                        {% for value in txn.values() %}
                        <td>{{ value }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    {% if ai_recommendations %}
    <div class="ai-recommendations card card-body mb-4">
        <h4>AI Recommendations</h4>
        <ul>
            {% for rec in ai_recommendations %}
            <li>{{ rec }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for downloads to prevent UI blocking
    const downloadButtons = document.querySelectorAll('.btn-success');
    
    downloadButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const originalText = this.textContent;
            const downloadUrl = this.href;
            
            // Show loading state
            this.textContent = 'Preparing Download...';
            this.disabled = true;
            this.classList.remove('btn-success');
            this.classList.add('btn-secondary');
            
            // Create hidden iframe for download (prevents page blocking)
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = downloadUrl;
            
            // Add to page
            document.body.appendChild(iframe);
            
            // Reset button after a short delay
            setTimeout(() => {
                this.textContent = originalText;
                this.disabled = false;
                this.classList.remove('btn-secondary');
                this.classList.add('btn-success');
                
                // Remove iframe
                document.body.removeChild(iframe);
            }, 2000);
        });
    });
    
    // Add navigation buttons
    const navigationDiv = document.createElement('div');
    navigationDiv.className = 'text-center mt-4';
    navigationDiv.innerHTML = `
        <a href="{{ url_for('index') }}" class="btn btn-primary me-3">
            <i class="fas fa-upload"></i> Process Another File
        </a>
        <a href="{{ url_for('home_page') }}" class="btn btn-outline-secondary">
            <i class="fas fa-home"></i> Back to Home
        </a>
    `;
    
    document.querySelector('.container').appendChild(navigationDiv);
});
</script>
{% endblock %}